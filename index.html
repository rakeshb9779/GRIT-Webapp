<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grit | Track you.</title>
    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .bg-grit-dark {
            background-color: #1a202c; /* A dark color for the header */
        }
        .text-grit-accent {
            color: #d8b4fe; /* A purple accent color */
        }
        .progress-bar-protein {
            height: 10px;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-grit-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600">Loading your data...</p>
        </div>
    </div>

    <div class="min-h-screen max-w-lg mx-auto p-4 flex flex-col">

        <!-- Header -->
        <header class="bg-white rounded-xl shadow-md p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <!-- SVG Logo with a bicep icon and heart rate line -->
                    <svg class="h-10 w-10 mr-2 text-grit-accent" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12.24 16.24c-1.42.0-2.58-1.16-2.58-2.58 0-1.42 1.16-2.58 2.58-2.58s2.58 1.16 2.58 2.58c0 1.42-1.16 2.58-2.58 2.58z" />
                        <path d="M16 11c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm5-2h-3v-2c0-.55-.45-1-1-1h-2c-.55 0-1 .45-1 1v2h-3v-2c0-.55-.45-1-1-1h-2c-.55 0-1 .45-1 1v2h-3v-2c0-.55-.45-1-1-1h-2c-.55 0-1 .45-1 1v3.5c0 .76-.41 1.44-1.07 1.81-.66.37-1.43.34-2.07-.09-.64-.43-1.04-1.1-1.04-1.84v-2c0-.55-.45-1-1-1s-1 .45-1 1v2c0 2.21 1.79 4 4 4h1.5c.83 0 1.5.67 1.5 1.5v.5c0 .55-.45 1-1 1s-1-.45-1-1v-.5c0-.28-.22-.5-.5-.5h-2c-1.1 0-2 .9-2 2v1c0 .55.45 1 1 1s1-.45 1-1v-1c0-.28.22-.5.5-.5h2c1.1 0 2-.9 2-2v-.5c0-.55.45-1 1-1s1 .45 1 1v.5c0 .28-.22.5-.5.5h-1c-.28 0-.5.22-.5.5v1c0 .55.45 1 1 1s1-.45 1-1v-1c0-.28.22-.5.5-.5h2c1.1 0 2-.9 2-2v-.5c0-.55.45-1 1-1s1 .45 1 1v.5c0 .28-.22.5-.5.5h-1c-.28 0-.5.22-.5.5v1c0 .55.45 1 1 1s1-.45 1-1v-1c0-.28.22-.5.5-.5h2c1.1 0 2-.9 2-2v-.5c0-.55.45-1 1-1s1 .45 1 1v.5c0 .28-.22.5-.5.5h-1c-.28 0-.5.22-.5.5v1c0 .55.45 1 1 1s1-.45 1-1v-1c0-.28.22-.5.5-.5h2c.55 0 1-.45 1-1v-2c0-.55-.45-1-1-1z" />
                    </svg>
                    <div class="flex flex-col">
                        <h1 class="text-3xl font-bold">Grit</h1>
                        <p class="text-sm font-light text-gray-500">Track you.</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-between items-center bg-white rounded-xl shadow-md p-2 mb-6">
            <button id="nav-dashboard" class="flex-1 p-3 text-center font-semibold rounded-lg text-grit-accent border-b-2 border-grit-accent transition-all">Dashboard</button>
            <button id="nav-workouts" class="flex-1 p-3 text-center font-semibold rounded-lg text-gray-500 hover:text-grit-accent transition-all">Workouts</button>
            <button id="nav-diet" class="flex-1 p-3 text-center font-semibold rounded-lg text-gray-500 hover:text-grit-accent transition-all">Diet</button>
        </nav>

        <!-- Main Content Views -->
        <main class="flex-grow">
            <!-- Dashboard View -->
            <section id="view-dashboard" class="space-y-6">
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4">Today's Progress</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-semibold">Protein</span>
                            <span id="protein-progress-text" class="text-sm font-medium text-gray-500">0g / 0g</span>
                        </div>
                        <div class="bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                            <div id="protein-progress-bar" class="bg-grit-accent h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4">Daily Totals</h2>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-gray-100 rounded-lg p-4">
                            <p id="total-calories" class="text-2xl font-bold">0</p>
                            <span class="text-sm text-gray-500">Calories</span>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-4">
                            <p id="total-carbs" class="text-2xl font-bold">0g</p>
                            <span class="text-sm text-gray-500">Carbs</span>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-4">
                            <p id="total-fats" class="text-2xl font-bold">0g</p>
                            <span class="text-sm text-gray-500">Fats</span>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-4">
                            <p id="total-protein" class="text-2xl font-bold">0g</p>
                            <span class="text-sm text-gray-500">Protein</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Workouts View -->
            <section id="view-workouts" class="space-y-6 hidden">
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4">Today's Workout</h2>
                    <div id="workout-list" class="space-y-4">
                        <!-- Workout plan will be dynamically inserted here -->
                    </div>
                </div>
            </section>

            <!-- Diet View -->
            <section id="view-diet" class="space-y-6 hidden">
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4">Saved Meals</h2>
                    <div id="meal-list" class="space-y-4">
                        <!-- Saved meals will be dynamically inserted here -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Google Sheets URLs
        const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx4vqDUyefKyYz6ehD_akDUJNOtDd15vVknLId1gB67izA3n02n6vxbuBHKpXjKHPgI/exec';
        const CSV_URLS = {
            workouts: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQiJvI_6Sskh-ei7zjY-8lFbUoFY-2n--zZQAgvnucn3WlJlrr5MFB93j5x9WKZY2pOW3UEjvB8sfY_/pub?gid=0&single=true&output=csv',
            workoutPlan: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQiJvI_6Sskh-ei7zjY-8lFbUoFY-2n--zZQAgvnucn3WlJlrr5MFB93j5x9WKZY2pOW3UEjvB8sfY_/pub?gid=1675295238&single=true&output=csv',
            foodLibrary: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQiJvI_6Sskh-ei7zjY-8lFbUoFY-2n--zZQAgvnucn3WlJlrr5MFB93j5x9WKZY2pOW3UEjvB8sfY_/pub?gid=1110434829&single=true&output=csv',
            savedMeals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQiJvI_6Sskh-ei7zjY-8lFbUoFY-2n--zZQAgvnucn3WlJlrr5MFB93j5x9WKZY2pOW3UEjvB8sfY_/pub?gid=1017602197&single=true&output=csv',
            goals: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQiJvI_6Sskh-ei7zjY-8sI_6Sskh-ei7zjY-8lFbUoFY-2n--zZQAgvnucn3WlJlrr5MFB93j5x9WKZY2pOW3UEjvB8sfY_/pub?gid=2043123073&single=true&output=csv',
            dietLog: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQiJvI_6Sskh-ei7zjY-8lFbUoFY-2n--zZQAgvnucn3WlJlrr5MFB93j5x9WKZY2pOW3UEjvB8sfY_/pub?gid=1625601626&single=true&output=csv'
        };

        // UI Elements
        const loadingScreen = document.getElementById('loading');
        const views = {
            dashboard: document.getElementById('view-dashboard'),
            workouts: document.getElementById('view-workouts'),
            diet: document.getElementById('view-diet')
        };
        const navButtons = {
            dashboard: document.getElementById('nav-dashboard'),
            workouts: document.getElementById('nav-workouts'),
            diet: document.getElementById('nav-diet')
        };
        const workoutList = document.getElementById('workout-list');
        const mealList = document.getElementById('meal-list');
        const proteinProgressBar = document.getElementById('protein-progress-bar');
        const proteinProgressText = document.getElementById('protein-progress-text');
        const totalCalories = document.getElementById('total-calories');
        const totalCarbs = document.getElementById('total-carbs');
        const totalFats = document.getElementById('total-fats');
        const totalProtein = document.getElementById('total-protein');

        // App State
        let data = {};
        let dailyTotals = {
            calories: 0,
            protein: 0,
            carbs: 0,
            fats: 0
        };

        // --- Core Functions ---

        /**
         * Fetches and parses CSV data from a given URL.
         * @param {string} url The URL of the Google Sheet CSV export.
         * @returns {Promise<Object[]>} An array of objects, where each object is a row.
         */
        async function fetchData(url) {
            try {
                const response = await fetch(url);
                const csvText = await response.text();
                return parseCsv(csvText);
            } catch (error) {
                console.error('Error fetching data from ' + url, error);
                return [];
            }
        }

        /**
         * Parses CSV text into an array of objects.
         * @param {string} csv The raw CSV text.
         * @returns {Object[]} An array of row objects.
         */
        function parseCsv(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(header => header.trim());
            const rows = lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                    return obj;
                }, {});
            });
            return rows;
        }

        /**
         * Posts data to the Google Apps Script API.
         * @param {string} sheetName The name of the target sheet.
         * @param {Object} payload The data to be logged.
         * @returns {Promise<any>} The response from the Apps Script.
         */
        async function postData(sheetName, payload) {
            try {
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sheet: sheetName, data: payload })
                });
                return await response.json();
            } catch (error) {
                console.error('Error posting data to Apps Script:', error);
            }
        }

        /**
         * Main function to initialize the app.
         */
        async function init() {
            try {
                // Fetch all data concurrently
                const [
                    workoutsData,
                    workoutPlanData,
                    foodLibraryData,
                    savedMealsData,
                    goalsData,
                    dietLogData
                ] = await Promise.all([
                    fetchData(CSV_URLS.workouts),
                    fetchData(CSV_URLS.workoutPlan),
                    fetchData(CSV_URLS.foodLibrary),
                    fetchData(CSV_URLS.savedMeals),
                    fetchData(CSV_URLS.goals),
                    fetchData(CSV_URLS.dietLog)
                ]);

                // Store data in a global object
                data.workouts = workoutsData;
                data.workoutPlan = workoutPlanData;
                data.foodLibrary = foodLibraryData;
                data.savedMeals = savedMealsData;
                data.goals = goalsData;
                data.dietLog = dietLogData;

                // Process initial state
                calculateDailyTotals();
                renderDashboard();
                renderWorkoutPlan();
                renderSavedMeals();

                // Hide loading screen
                loadingScreen.classList.add('hidden');
                switchView('dashboard');

            } catch (error) {
                console.error('Failed to initialize app:', error);
                loadingScreen.innerHTML = '<p class="text-red-500">Failed to load data. Please check your sheet links.</p>';
            }
        }

        // --- UI Rendering Functions ---

        /**
         * Renders the dashboard with daily progress and goals.
         */
        function renderDashboard() {
            const proteinGoal = data.goals.find(g => g['Goal Name'] === 'Daily Protein Goal')?.Value || 0;
            const currentProtein = dailyTotals.protein;

            proteinProgressText.textContent = `${currentProtein}g / ${proteinGoal}g`;
            const proteinPercentage = proteinGoal > 0 ? (currentProtein / proteinGoal) * 100 : 0;
            proteinProgressBar.style.width = `${Math.min(proteinPercentage, 100)}%`;

            totalCalories.textContent = Math.round(dailyTotals.calories);
            totalCarbs.textContent = `${Math.round(dailyTotals.carbs)}g`;
            totalFats.textContent = `${Math.round(dailyTotals.fats)}g`;
            totalProtein.textContent = `${Math.round(dailyTotals.protein)}g`;
        }

        /**
         * Renders the workout plan for the current day.
         */
        function renderWorkoutPlan() {
            const today = new Date().toLocaleString('en-us', { weekday: 'long' });
            const todayPlan = data.workoutPlan.find(d => d.Day === today);
            workoutList.innerHTML = '';

            if (!todayPlan) {
                workoutList.innerHTML = '<p class="text-gray-500">No workout plan found for today.</p>';
                return;
            }

            // Filter out empty exercise columns
            const exercises = Object.keys(todayPlan)
                .filter(key => key.startsWith('Exercise') && todayPlan[key] && todayPlan[key] !== '')
                .map(key => todayPlan[key]);

            exercises.forEach(exercise => {
                const lastLog = data.workouts.filter(log => log.Exercise === exercise)
                    .sort((a, b) => new Date(b.Date) - new Date(a.Date))[0];

                const lastReps = lastLog ? lastLog.Reps : 'N/A';
                const lastWeight = lastLog ? lastLog['Weight (kg)'] : 'N/A';

                const exerciseHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <div class="flex items-center justify-between">
                            <h3 class="font-bold text-lg">${exercise}</h3>
                        </div>
                        <div class="mt-2 text-sm text-gray-500">
                            Last Set: ${lastReps} reps @ ${lastWeight} kg
                        </div>
                        <div id="log-form-${exercise.replace(/\s/g, '-')}" class="mt-4 space-y-2">
                            <!-- Sets will be added dynamically -->
                            <div class="flex items-center gap-2">
                                <input type="number" placeholder="Reps" class="w-1/2 p-2 rounded-lg border border-gray-300 focus:outline-none focus:border-grit-accent rep-input">
                                <input type="number" placeholder="Weight (kg)" class="w-1/2 p-2 rounded-lg border border-gray-300 focus:outline-none focus:border-grit-accent weight-input">
                                <button onclick="logWorkout('${exercise}')" class="bg-grit-accent text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-600 transition-colors">Log Set</button>
                            </div>
                        </div>
                    </div>
                `;
                workoutList.innerHTML += exerciseHTML;
            });
        }
        
        /**
         * Renders the saved meals list.
         */
        function renderSavedMeals() {
            mealList.innerHTML = '';
            data.savedMeals.forEach(meal => {
                const mealContents = JSON.parse(meal['Contents (JSON)']);
                const contentsString = mealContents.map(item => `${item.quantity} of ${item.name}`).join(', ');

                const mealHTML = `
                    <div class="card p-4 flex items-center justify-between">
                        <div>
                            <h3 class="font-bold">${meal['Meal Name']}</h3>
                            <p class="text-sm text-gray-500">${contentsString}</p>
                        </div>
                        <button onclick="logMeal('${meal['Meal Name']}')" class="bg-grit-accent text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-600 transition-colors">
                            Log
                        </button>
                    </div>
                `;
                mealList.innerHTML += mealHTML;
            });
        }
        
        // --- State Management and Data Logging ---

        /**
         * Logs a new workout set.
         * @param {string} exercise The name of the exercise.
         */
        async function logWorkout(exercise) {
            const formId = `log-form-${exercise.replace(/\s/g, '-')}`;
            const repsInput = document.querySelector(`#${formId} .rep-input`);
            const weightInput = document.querySelector(`#${formId} .weight-input`);
            const reps = repsInput.value;
            const weight = weightInput.value;

            if (!reps || !weight) {
                alert('Please enter reps and weight.'); // Using alert as per instructions, will replace with UI later.
                return;
            }

            const today = new Date().toLocaleDateString('en-US');
            const newLog = {
                Date: today,
                Exercise: exercise,
                Sets: '1', // Simplified to 1, user logs one set at a time
                Reps: reps,
                'Weight (kg)': weight,
                Notes: ''
            };

            await postData('Workouts', newLog);
            alert('Workout logged successfully!'); // Using alert as per instructions
            repsInput.value = '';
            weightInput.value = '';
            // Refresh data to show last logged set
            await fetchData(CSV_URLS.workouts).then(d => {
                data.workouts = d;
                renderWorkoutPlan();
            });
        }

        /**
         * Logs a meal and updates the dashboard.
         * @param {string} mealName The name of the meal.
         */
        async function logMeal(mealName) {
            const meal = data.savedMeals.find(m => m['Meal Name'] === mealName);
            if (!meal) return;
            
            const mealContents = JSON.parse(meal['Contents (JSON)']);
            let mealProtein = 0;
            let mealCarbs = 0;
            let mealFats = 0;
            let mealCalories = 0;

            const today = new Date().toLocaleDateString('en-US');

            for (const item of mealContents) {
                const foodItem = data.foodLibrary.find(f => f['Food Item'] === item.name);
                if (foodItem) {
                    const quantity = parseFloat(item.quantity) || 0;
                    const logEntry = {
                        Date: today,
                        Meal: mealName,
                        'Food Item': foodItem['Food Item'],
                        Quantity: quantity,
                        'Logged Protein (g)': (parseFloat(foodItem['Protein (g)']) * quantity).toFixed(2),
                        'Logged Carbs (g)': (parseFloat(foodItem['Carbs (g)']) * quantity).toFixed(2),
                        'Logged Fats (g)': (parseFloat(foodItem['Fats (g)']) * quantity).toFixed(2),
                        'Logged Calories': (parseFloat(foodItem['Calories']) * quantity).toFixed(2),
                    };
                    await postData('Diet Log', logEntry);
                    
                    mealProtein += parseFloat(logEntry['Logged Protein (g)']);
                    mealCarbs += parseFloat(logEntry['Logged Carbs (g)']);
                    mealFats += parseFloat(logEntry['Logged Fats (g)']);
                    mealCalories += parseFloat(logEntry['Logged Calories']);
                }
            }

            dailyTotals.protein += mealProtein;
            dailyTotals.carbs += mealCarbs;
            dailyTotals.fats += mealFats;
            dailyTotals.calories += mealCalories;

            renderDashboard();
            alert(`${mealName} logged successfully!`); // Using alert as per instructions

            // Visually "remove" the logged meal by hiding it
            const loggedButton = document.querySelector(`button[onclick="logMeal('${mealName}')"]`);
            if (loggedButton) {
                loggedButton.closest('.card').classList.add('hidden');
            }
        }
        
        /**
         * Calculates the total macros for the current day from the diet log.
         */
        function calculateDailyTotals() {
            const today = new Date().toLocaleDateString('en-US');
            const todayLogs = data.dietLog.filter(log => log.Date === today);
            
            dailyTotals = {
                calories: 0,
                protein: 0,
                carbs: 0,
                fats: 0
            };
            
            todayLogs.forEach(log => {
                dailyTotals.calories += parseFloat(log['Logged Calories']) || 0;
                dailyTotals.protein += parseFloat(log['Logged Protein (g)']) || 0;
                dailyTotals.carbs += parseFloat(log['Logged Carbs (g)']) || 0;
                dailyTotals.fats += parseFloat(log['Logged Fats (g)']) || 0;
            });
        }

        // --- UI Interactions ---

        /**
         * Switches the active view and navigation button.
         * @param {string} viewName The name of the view to switch to.
         */
        function switchView(viewName) {
            Object.keys(views).forEach(key => {
                views[key].classList.add('hidden');
                navButtons[key].classList.remove('text-grit-accent', 'border-b-2', 'border-grit-accent');
                navButtons[key].classList.add('text-gray-500');
            });
            views[viewName].classList.remove('hidden');
            navButtons[viewName].classList.remove('text-gray-500');
            navButtons[viewName].classList.add('text-grit-accent', 'border-b-2', 'border-grit-accent');
        }

        // Event listeners for navigation
        navButtons.dashboard.addEventListener('click', () => switchView('dashboard'));
        navButtons.workouts.addEventListener('click', () => switchView('workouts'));
        navButtons.diet.addEventListener('click', () => switchView('diet'));

        // Start the application
        window.onload = init;
    </script>

</body>
</html>
