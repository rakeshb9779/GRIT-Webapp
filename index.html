<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GRIT: Track you</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/dist/phosphor.js"></script>
  <style>
    body { touch-action: pan-y; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .chart-container { position: relative; width: 100%; height: 300px; }
    .workout-card-container { position: relative; }
    .delete-workout-btn {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background: transparent;
        border: none;
        color: #ef4444; /* red-500 */
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 9999px;
        transition: background-color 0.2s;
    }
    .delete-workout-btn:hover {
        background-color: rgba(239, 68, 68, 0.1);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans p-4 flex flex-col min-h-screen pb-24">
  <!-- Brand Header -->
  <header class="text-center mb-6">
    <h1 class="text-3xl font-bold text-white mb-2 tracking-wide">GRIT</h1>
    <p class="text-gray-400 text-lg">Track you</p>
  </header>

  <!-- Main Content Area -->
  <main id="app-content" class="flex-grow">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50 transition-opacity duration-500">
      <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-lime-400"></div>
      <p class="mt-4 text-lime-400 text-lg">Loading data...</p>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 bg-gray-950 bg-opacity-80 z-[100] hidden items-center justify-center p-4">
      <div id="modal-content" class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full">
        <h3 id="modal-title" class="text-xl font-bold text-white mb-4"></h3>
        <p id="modal-message" class="text-gray-300 mb-4"></p>
        <form id="modal-form" class="space-y-4 hidden"></form>
        <div id="modal-buttons" class="flex justify-end gap-2"></div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard" class="tab-content active p-2">
      <div class="grid grid-cols-1 gap-4">
        <!-- Protein Progress Card -->
        <div class="bg-gray-800 rounded-xl p-4 shadow-lg">
          <h2 class="text-xl font-semibold text-lime-400 mb-2">Today's Progress</h2>
          <div class="flex items-center justify-between mb-2">
            <span class="text-lg">Protein Goal</span>
            <span id="protein-progress-text" class="text-lg font-bold">0g / 0g</span>
          </div>
          <div class="w-full bg-gray-700 rounded-full h-2.5">
            <div id="protein-progress-bar" class="bg-lime-400 h-2.5 rounded-full" style="width: 0%;"></div>
          </div>
        </div>
        <!-- Daily Workout Plan Card -->
        <div class="bg-gray-800 rounded-xl p-4 shadow-lg">
          <h2 class="text-xl font-semibold text-lime-400 mb-2">Today's Workout</h2>
          <div id="daily-workout-plan" class="text-gray-300">
            <p>Loading workout plan...</p>
          </div>
          <button id="start-workout-btn" class="mt-4 w-full bg-lime-400 text-gray-900 font-bold py-2 rounded-lg transition hover:bg-lime-300 shadow-xl">
            Start Workout
          </button>
        </div>
        <!-- Recent Personal Bests Card -->
        <div class="bg-gray-800 rounded-xl p-4 shadow-lg">
          <h2 class="text-xl font-semibold text-lime-400 mb-2">Recent Personal Bests</h2>
          <div id="recent-prs" class="text-gray-300">
            <p>No recent PRs logged.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Workout Section -->
    <div id="workout" class="tab-content p-2">
      <!-- This view is for the active, guided workout -->
      <div id="active-workout-session" class="hidden">
        <h2 class="text-2xl font-bold mb-4 text-lime-400">Today's Session</h2>
        <div id="active-workout-exercises" class="space-y-4">
          <!-- Exercise cards will be injected here by JS -->
        </div>
        <button id="finish-workout-btn" class="mt-6 w-full bg-gray-600 text-gray-200 font-bold py-3 rounded-lg transition hover:bg-gray-500">
          Finish Workout
        </button>
      </div>

      <!-- This is the default view showing the log history -->
      <div id="default-workout-view">
        <h2 class="text-2xl font-bold mb-4 text-lime-400">Workout Log</h2>
        <div id="workout-log-list" class="space-y-4">
          <p class="text-center text-gray-400">Start a workout from the Home tab or log a single exercise below.</p>
        </div>
        <button id="log-workout-btn" class="mt-6 w-full bg-lime-400 text-gray-900 font-bold py-3 rounded-lg transition hover:bg-lime-300 shadow-xl">
          Log Single Exercise
        </button>
      </div>
    </div>

    <!-- Diet Section -->
    <div id="diet" class="tab-content p-2">
      <h2 class="text-2xl font-bold mb-4 text-lime-400">Diet Tracker</h2>
      <div id="diet-progress-dashboard" class="bg-gray-800 rounded-xl p-4 shadow-lg mb-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-lg font-semibold">Today's Macros</span>
          <span id="diet-totals-text" class="text-sm text-gray-400">P: 0g | C: 0g | F: 0g</span>
        </div>
        <div class="flex flex-col gap-2">
          <div class="flex justify-between items-center">
            <span class="text-gray-300">Protein</span>
            <span id="protein-today" class="font-bold">0g / 0g</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-300">Carbs</span>
            <span id="carbs-today" class="font-bold">0g</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-300">Fats</span>
            <span id="fats-today" class="font-bold">0g</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-300">Calories</span>
            <span id="calories-today" class="font-bold">0 kcal</span>
          </div>
        </div>
      </div>
      <h3 class="text-xl font-semibold text-lime-400 mb-2">Quick-Add Meals</h3>
      <div id="quick-add-meals" class="grid grid-cols-2 gap-3 mb-6">
        <p class="text-center text-gray-400 col-span-2">Loading saved meals...</p>
      </div>
      <h3 class="text-xl font-semibold text-lime-400 mb-2">Today's Log</h3>
      <div id="diet-log-list" class="space-y-2">
        <p class="text-center text-gray-400">Log a meal to see it here.</p>
      </div>
      <button id="log-meal-btn" class="mt-6 w-full bg-lime-400 text-gray-900 font-bold py-3 rounded-lg transition hover:bg-lime-300 shadow-xl">
        Add Food
      </button>
    </div>

    <!-- Progress Section -->
    <div id="progress" class="tab-content p-2">
      <h2 class="text-2xl font-bold mb-4 text-lime-400">Progress Dashboard</h2>
      <div class="grid grid-cols-1 gap-4">
        <div class="bg-gray-800 rounded-xl p-4 shadow-lg">
          <h3 class="text-xl font-semibold text-gray-200 mb-2">Weight Over Time</h3>
          <div class="chart-container">
            <canvas id="weight-chart"></canvas>
          </div>
        </div>
        <div class="bg-gray-800 rounded-xl p-4 shadow-lg">
          <h3 class="text-xl font-semibold text-gray-200 mb-2">Log Progress</h3>
          <form id="log-progress-form" class="space-y-4">
            <div>
              <label for="progress-date" class="block text-sm font-medium text-gray-400">Date</label>
              <input type="date" id="progress-date" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600 focus:border-lime-400 focus:ring focus:ring-lime-400 focus:ring-opacity-50" required />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label for="progress-weight" class="block text-sm font-medium text-gray-400">Weight (kg)</label>
                <input type="number" step="0.1" id="progress-weight" placeholder="e.g., 75.5" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" required />
              </div>
              <div>
                <label for="progress-waist" class="block text-sm font-medium text-gray-400">Waist (in)</label>
                <input type="number" step="0.1" id="progress-waist" placeholder="e.g., 32" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" />
              </div>
              <div>
                <label for="progress-chest" class="block text-sm font-medium text-gray-400">Chest (in)</label>
                <input type="number" step="0.1" id="progress-chest" placeholder="e.g., 40" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" />
              </div>
              <div>
                <label for="progress-arms" class="block text-sm font-medium text-gray-400">Arms (in)</label>
                <input type="number" step="0.1" id="progress-arms" placeholder="e.g., 14" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" />
              </div>
               <div>
                <label for="progress-thighs" class="block text-sm font-medium text-gray-400">Thighs (in)</label>
                <input type="number" step="0.1" id="progress-thighs" placeholder="e.g., 23" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" />
              </div>
            </div>
            <div>
              <label for="progress-photo" class="block text-sm font-medium text-gray-400">Photo Link</label>
              <input type="text" id="progress-photo" placeholder="Optional URL" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" />
            </div>
            <button type="submit" class="w-full bg-lime-400 text-gray-900 font-bold py-2 rounded-lg transition hover:bg-lime-300">Save Progress</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Settings Section -->
    <div id="settings" class="tab-content p-2">
      <h2 class="text-2xl font-bold mb-4 text-lime-400">Settings</h2>
      <div class="bg-gray-800 rounded-xl p-4 shadow-lg">
        <h3 class="text-xl font-semibold text-gray-200 mb-2">Your Goals</h3>
        <form id="update-goals-form" class="space-y-4">
          <div id="goals-list">
             <p class="text-gray-400">Loading goals...</p>
          </div>
          <button type="submit" class="w-full bg-lime-400 text-gray-900 font-bold py-2 rounded-lg transition hover:bg-lime-300">Save Goals</button>
        </form>
      </div>
    </div>
  </main>

  <!-- Bottom Navigation Bar -->
  <nav class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 flex justify-around items-center p-3 text-gray-400 z-40">
    <a href="#" id="nav-dashboard" class="nav-item flex flex-col items-center justify-center p-2 rounded-lg text-lime-400">
      <i class="ph-house-fill text-2xl"></i>
      <span class="text-xs mt-1">Home</span>
    </a>
    <a href="#" id="nav-workout" class="nav-item flex flex-col items-center justify-center p-2 rounded-lg hover:text-lime-400">
      <i class="ph-barbell text-2xl"></i>
      <span class="text-xs mt-1">Workout</span>
    </a>
    <a href="#" id="nav-diet" class="nav-item flex flex-col items-center justify-center p-2 rounded-lg hover:text-lime-400">
      <i class="ph-fork-knife text-2xl"></i>
      <span class="text-xs mt-1">Diet</span>
    </a>
    <a href="#" id="nav-progress" class="nav-item flex flex-col items-center justify-center p-2 rounded-lg hover:text-lime-400">
      <i class="ph-chart-line text-2xl"></i>
      <span class="text-xs mt-1">Progress</span>
    </a>
    <a href="#" id="nav-settings" class="nav-item flex flex-col items-center justify-center p-2 rounded-lg hover:text-lime-400">
      <i class="ph-gear text-2xl"></i>
      <span class="text-xs mt-1">Settings</span>
    </a>
  </nav>

  <script>
    // ==================== CONFIG ====================
    const appsScriptURL = 'https://script.google.com/macros/s/AKfycbx4vqDUyefKyYz6ehD_akDUJNOtDd15vVknLId1gB67izA3n02n6vxbuBHKpXjKHPgI/exec';

    // ==================== STATE ====================
    let appData = {};
    let chartInstance;
    const today = new Date().toISOString().slice(0, 10);

    // Nav refs
    const navItems = {
      dashboard: document.getElementById('nav-dashboard'),
      workout: document.getElementById('nav-workout'),
      diet: document.getElementById('nav-diet'),
      progress: document.getElementById('nav-progress'),
      settings: document.getElementById('nav-settings'),
    };

    // Modal elements
    const modalContainer = document.getElementById('modal-container');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalForm = document.getElementById('modal-form');
    const modalButtons = document.getElementById('modal-buttons');

    // ==================== UTIL: MODAL ====================
    function showModal(title, message, formHtml = '', buttonsHtml = '') {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modalForm.innerHTML = formHtml;
      modalButtons.innerHTML = buttonsHtml;
      modalForm.classList.toggle('hidden', formHtml === '');
      modalContainer.classList.remove('hidden');
      modalContainer.classList.add('flex');
    }
    function hideModal() {
      modalContainer.classList.remove('flex');
      modalContainer.classList.add('hidden');
    }

    // ==================== UTIL: LOADING ====================
    function showLoading(show) {
      const el = document.getElementById('loading-screen');
      if (show) {
          el.style.visibility = 'visible';
          el.style.opacity = '1';
      } else {
          el.style.opacity = '0';
          setTimeout(() => { el.style.visibility = 'hidden'; }, 500); // match transition duration
      }
    }

    // ==================== FETCH HELPERS ====================
    async function postData(payload, showSuccessModal = true) {
      showLoading(true);
      try {
        const body = new URLSearchParams();
        body.set('action', payload.action);
        body.set('data', JSON.stringify(payload));
        
        const response = await fetch(appsScriptURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body,
          mode: 'cors'
        });

        const text = await response.text();
        let data;
        try { 
          data = JSON.parse(text); 
        } catch (e) {
          console.error("Non-JSON response from server:", text);
          throw new Error('Non-JSON response from server. Check deployment.');
        }

        if (data.success) {
            if (showSuccessModal) {
              showModal('Success', data.message || 'Operation successful!', '', `<button class="bg-lime-500 text-white font-bold py-2 px-4 rounded-lg" onclick="hideModal()">OK</button>`);
            }
        } else {
            throw new Error(data.error || 'An unknown error occurred.');
        }
        return data.success; // Return success status
      } catch (error) {
        showModal('Connection Error', `Could not save data. Error: ${error.message}`, '', `<button class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg" onclick="hideModal()">OK</button>`);
        console.error('Error posting data:', error);
        return false; // Return failure status
      } finally {
        showLoading(false);
      }
    }

    async function fetchData() {
      showLoading(true);
      try {
        const url = `${appsScriptURL}?action=getDashboardData&cb=${Date.now()}`;
        const response = await fetch(url, { mode: 'cors' });
        
        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);

        const text = await response.text();
        let responseData;
        try { responseData = JSON.parse(text); } catch { throw new Error('Non-JSON response (check deployment access/URL)'); }

        if (responseData.success) {
          appData = responseData.data;
          renderApp();
        } else {
          throw new Error(responseData.error || 'The script returned an error.');
        }
      } catch (error) {
        console.error('Fetch operation failed:', error);
        showModal('Connection Error', `Could not connect to Google Apps Script. Error: ${error.message}`, '', `<button class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg" onclick="hideModal()">OK</button>`);
      } finally {
        showLoading(false);
      }
    }

    // ==================== RENDERERS ====================
    function renderApp() {
      renderDashboard();
      renderWorkoutSection();
      renderDietSection();
      renderProgressSection();
      renderSettingsSection();
    }

    function dayNameToIndex(name) {
      const map = { sunday:0, monday:1, tuesday:2, wednesday:3, thursday:4, friday:5, saturday:6 };
      return map[String(name || '').toLowerCase()] ?? -1;
    }

    function renderDashboard() {
      const goals = (appData.goals || []).reduce((acc, g) => ({ ...acc, [g['Goal Name']]: g.Value }), {});
      const dietLog = (appData.dietLog || []).filter(log => log.Date === today);
      const todayProtein = dietLog.reduce((sum, log) => sum + (parseFloat(log['Logged Protein (g)']) || 0), 0);
      const totalProteinGoal = parseFloat(goals['Daily Protein Goal (g)']) || 0;
      const proteinProgressPercent = totalProteinGoal > 0 ? (todayProtein / totalProteinGoal) * 100 : 0;

      document.getElementById('protein-progress-text').textContent = `${Math.round(todayProtein)}g / ${totalProteinGoal}g`;
      document.getElementById('protein-progress-bar').style.width = `${Math.min(proteinProgressPercent, 100)}%`;

      const todayIndex = new Date().getDay();
      const planArr = appData.workoutPlan || [];
      const workoutPlanToday = planArr.find(p => dayNameToIndex(p.Day) === todayIndex);

      const workoutPlanList = document.getElementById('daily-workout-plan');
      workoutPlanList.innerHTML = '';
      if (workoutPlanToday && Object.values(workoutPlanToday).some(v => v && v !== workoutPlanToday.Day)) {
        Object.keys(workoutPlanToday).forEach(key => {
          if (key !== 'Day' && workoutPlanToday[key]) {
            const p = document.createElement('p');
            p.textContent = `• ${workoutPlanToday[key]}`;
            workoutPlanList.appendChild(p);
          }
        });
        document.getElementById('start-workout-btn').disabled = false;
      } else {
        workoutPlanList.innerHTML = '<p>No workout planned for today.</p>';
        document.getElementById('start-workout-btn').disabled = true;
      }

      const recentPRs = findRecentPRs();
      const prsDiv = document.getElementById('recent-prs');
      prsDiv.innerHTML = '';
      if (recentPRs.length > 0) {
        recentPRs.forEach(pr => {
          prsDiv.innerHTML += `<p>${pr.Exercise} PR: ${pr['Weight (kg)']}kg x ${pr.Reps} reps</p>`;
        });
      } else {
        prsDiv.innerHTML = '<p>Log some workouts to see your personal bests here!</p>';
      }
    }

    function renderWorkoutSection() {
        const workoutLogList = document.getElementById('workout-log-list');
        workoutLogList.innerHTML = '';
        const workouts = (appData.workouts || []).slice().sort((a, b) => new Date(b.Date) - new Date(a.Date));
        if (workouts.length > 0) {
            workouts.forEach(log => {
                const workoutCard = document.createElement('div');
                workoutCard.className = 'workout-card-container bg-gray-800 rounded-lg p-4 shadow-md';
                workoutCard.innerHTML = `
                    <button class="delete-workout-btn" data-row-index="${log.rowIndex}" aria-label="Delete workout">
                        <i class="ph-trash text-xl"></i>
                    </button>
                    <h4 class="font-bold text-lime-400">${log.Date} - ${log.Exercise}</h4>
                    <p>Sets: ${log.Sets}, Reps: ${log.Reps}, Weight: ${log['Weight (kg)']}kg</p>
                    <p class="text-sm text-gray-400">Notes: ${log.Notes || ''}</p>`;
                workoutLogList.appendChild(workoutCard);
            });
        } else {
            workoutLogList.innerHTML = '<p class="text-center text-gray-400">No workouts logged yet.</p>';
        }
    }


    function renderDietSection() {
      const goals = (appData.goals || []).reduce((acc, g) => ({ ...acc, [g['Goal Name']]: g.Value }), {});
      const dietLog = (appData.dietLog || []).filter(log => log.Date === today);
      const todayProtein = dietLog.reduce((sum, log) => sum + (parseFloat(log['Logged Protein (g)']) || 0), 0);
      const todayCarbs = dietLog.reduce((sum, log) => sum + (parseFloat(log['Logged Carbs (g)']) || 0), 0);
      const todayFats = dietLog.reduce((sum, log) => sum + (parseFloat(log['Logged Fats (g)']) || 0), 0);
      const todayCalories = dietLog.reduce((sum, log) => sum + (parseFloat(log['Logged Calories']) || 0), 0);

      document.getElementById('protein-today').textContent = `${Math.round(todayProtein)}g / ${goals['Daily Protein Goal (g)'] || 0}g`;
      document.getElementById('carbs-today').textContent = `${Math.round(todayCarbs)}g`;
      document.getElementById('fats-today').textContent = `${Math.round(todayFats)}g`;
      document.getElementById('calories-today').textContent = `${Math.round(todayCalories)} kcal`;
      document.getElementById('diet-totals-text').textContent = `P: ${Math.round(todayProtein)}g | C: ${Math.round(todayCarbs)}g | F: ${Math.round(todayFats)}g`;

      const savedMealsList = document.getElementById('quick-add-meals');
      savedMealsList.innerHTML = '';
      (appData.savedMeals || []).forEach(meal => {
        const button = document.createElement('button');
        button.className = 'bg-gray-700 text-gray-200 py-3 rounded-lg shadow-md hover:bg-gray-600 transition';
        button.textContent = meal['Meal Name'];
        button.onclick = () => logSavedMeal(meal);
        savedMealsList.appendChild(button);
      });

      const dietLogList = document.getElementById('diet-log-list');
      dietLogList.innerHTML = '';
      if (dietLog.length > 0) {
        dietLog.forEach(log => {
          const logItem = document.createElement('div');
          logItem.className = 'bg-gray-800 rounded-lg p-3 shadow-md';
          logItem.innerHTML = `
            <p class="font-bold text-gray-200">${log['Food Item']} (${log.Quantity})</p>
            <p class="text-sm text-gray-400">P: ${log['Logged Protein (g)']}g, C: ${log['Logged Carbs (g)']}g, F: ${log['Logged Fats (g)']}g</p>`;
          dietLogList.appendChild(logItem);
        });
      } else {
        dietLogList.innerHTML = '<p class="text-center text-gray-400">No meals logged today.</p>';
      }
    }

    function renderProgressSection() {
      const progressData = (appData.progress || [])
        .filter(d => d['Weight (kg)'])
        .sort((a, b) => new Date(a.Date) - new Date(b.Date));
      const labels = progressData.map(d => d.Date);
      const weights = progressData.map(d => parseFloat(d['Weight (kg)']));

      if (chartInstance) chartInstance.destroy();

      const ctx = document.getElementById('weight-chart').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Weight (kg)',
            data: weights,
            borderColor: 'rgb(134, 239, 172)',
            backgroundColor: 'rgba(134, 239, 172, 0.2)',
            tension: 0.1,
            fill: true,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
            y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
          },
          plugins: { legend: { labels: { color: 'white' } } },
        },
      });
    }

    function renderSettingsSection() {
        const goalsList = document.getElementById('goals-list');
        goalsList.innerHTML = '';
        (appData.goals || []).forEach(goal => {
            const goalName = goal['Goal Name'];
            const goalValue = goal.Value;
            const inputId = `goal-${goalName.replace(/\s+/g, '-')}`;
            goalsList.innerHTML += `
                <div>
                  <label for="${inputId}" class="block text-sm font-medium text-gray-400">${goalName}</label>
                  <input type="text" id="${inputId}" data-goal-name="${goalName}" value="${goalValue}" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" />
                </div>
            `;
        });
    }

    // ==================== FEATURES ====================
    function findRecentPRs() {
      const prs = {};
      (appData.workouts || []).forEach(workout => {
        const exercise = workout.Exercise;
        const weight = parseFloat(workout['Weight (kg)']);
        const reps = parseInt(workout.Reps, 10);
        if (!exercise || isNaN(weight) || isNaN(reps)) return;
        if (!prs[exercise] || weight > prs[exercise]['Weight (kg)']) {
            prs[exercise] = workout;
        }
      });
      return Object.values(prs).sort((a, b) => new Date(b.Date) - new Date(a.Date)).slice(0, 5);
    }

    function logWorkout() {
      showModal('Log Single Exercise', 'Enter your workout details:', `
        <div>
          <label for="modal-exercise" class="block text-sm font-medium text-gray-400">Exercise</label>
          <input type="text" id="modal-exercise" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" required />
        </div>
        <div>
          <label for="modal-sets" class="block text-sm font-medium text-gray-400">Sets</label>
          <input type="number" id="modal-sets" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" required />
        </div>
        <div>
          <label for="modal-reps" class="block text-sm font-medium text-gray-400">Reps</label>
          <input type="number" id="modal-reps" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" required />
        </div>
        <div>
          <label for="modal-weight" class="block text-sm font-medium text-gray-400">Weight (kg)</label>
          <input type="number" step="0.1" id="modal-weight" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" required />
        </div>
        <div>
          <label for="modal-notes" class="block text-sm font-medium text-gray-400">Notes (optional)</label>
          <input type="text" id="modal-notes" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" />
        </div>`, `<button type="submit" form="modal-form" class="bg-lime-400 text-gray-900 font-bold py-2 px-4 rounded-lg">Save</button>
      <button type="button" class="bg-gray-700 text-gray-200 font-bold py-2 px-4 rounded-lg" onclick="hideModal()">Cancel</button>`);

      document.getElementById('modal-form').onsubmit = async (event) => {
        event.preventDefault();
        const payload = {
            action: 'logWorkout',
            date: today,
            exercise: document.getElementById('modal-exercise').value,
            sets: document.getElementById('modal-sets').value,
            reps: document.getElementById('modal-reps').value,
            weight: document.getElementById('modal-weight').value,
            notes: document.getElementById('modal-notes').value,
        };
        const success = await postData(payload);
        if (success) {
            hideModal();
            fetchData();
        }
      };
    }
    
    // --- NEW --- Function to confirm and handle workout deletion
    function confirmDeleteWorkout(rowIndex) {
        const workoutToDelete = appData.workouts.find(w => w.rowIndex == rowIndex);
        if (!workoutToDelete) return;

        showModal(
            'Confirm Deletion', 
            `Are you sure you want to delete the workout: ${workoutToDelete.Exercise} on ${workoutToDelete.Date}?`, 
            '', 
            `<button id="confirm-delete-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Delete</button>
             <button type="button" class="bg-gray-700 text-gray-200 font-bold py-2 px-4 rounded-lg" onclick="hideModal()">Cancel</button>`
        );

        document.getElementById('confirm-delete-btn').onclick = () => handleDeleteWorkout(rowIndex);
    }

    async function handleDeleteWorkout(rowIndex) {
        const payload = { action: 'deleteWorkout', rowIndex: Number(rowIndex) };
        const success = await postData(payload, false); // Don't show generic success modal

        if (success) {
            // --- OPTIMIZATION ---
            // Update local state and re-render instantly instead of full fetchData()
            const indexToRemove = appData.workouts.findIndex(w => w.rowIndex == rowIndex);
            if (indexToRemove > -1) {
                appData.workouts.splice(indexToRemove, 1);
            }
            renderWorkoutSection(); // Re-render only the workout list
            renderDashboard(); // Re-render dashboard to update PRs
            showModal('Deleted', 'The workout entry has been removed.', '', `<button class="bg-lime-500 text-white font-bold py-2 px-4 rounded-lg" onclick="hideModal()">OK</button>`);
        } else {
            // Error modal is already shown by postData()
            hideModal(); // Hide the confirmation modal if delete fails
        }
    }


    async function logSavedMeal(meal) {
      showModal('Logging Meal', `Logging "${meal['Meal Name']}" to your diet log...`);
      const savedMealContents = JSON.parse(meal['Contents (JSON)'] || '[]');
      const foodLibrary = appData.foodLibrary || [];
      const mealsToLog = savedMealContents.map(savedFood => {
        const foodItem = foodLibrary.find(f => f['Food Item'] === savedFood['Food Item']);
        if (!foodItem) return null;
        const quantity = savedFood.Quantity || 1;
        return {
          mealType: 'Saved Meal',
          foodItem: foodItem['Food Item'],
          quantity: quantity,
          protein: (parseFloat(foodItem['Protein (g)']) || 0) * quantity,
          carbs: (parseFloat(foodItem['Carbs (g)']) || 0) * quantity,
          fats: (parseFloat(foodItem['Fats (g)']) || 0) * quantity,
          calories: (parseFloat(foodItem.Calories) || 0) * quantity,
        };
      }).filter(Boolean);

      const payload = { action: 'logDiet', date: today, meals: mealsToLog };
      await postData(payload);
      hideModal();
      fetchData();
    }

    function addFoodItem() {
      showModal('Add Food Item', 'Enter food from your Food Library and quantity:', `
        <div>
          <label for="modal-food-item" class="block text-sm font-medium text-gray-400">Food Name</label>
          <input type="text" id="modal-food-item" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" required list="food-library-list" />
          <datalist id="food-library-list">
            ${(appData.foodLibrary || []).map(f => `<option value="${f['Food Item']}">`).join('')}
          </datalist>
        </div>
        <div>
          <label for="modal-quantity" class="block text-sm font-medium text-gray-400">Quantity</label>
          <input type="number" step="0.1" value="1" id="modal-quantity" class="w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" required />
        </div>`, `<button type="submit" form="modal-form" class="bg-lime-400 text-gray-900 font-bold py-2 px-4 rounded-lg">Add</button>
      <button type="button" class="bg-gray-700 text-gray-200 font-bold py-2 px-4 rounded-lg" onclick="hideModal()">Cancel</button>`);

      document.getElementById('modal-form').onsubmit = async (event) => {
        event.preventDefault();
        const foodItemName = document.getElementById('modal-food-item').value;
        const quantity = parseFloat(document.getElementById('modal-quantity').value);
        const food = (appData.foodLibrary || []).find(f => String(f['Food Item'] || '').toLowerCase() === String(foodItemName || '').toLowerCase());
        if (!food) {
          showModal('Error', 'Food item not found in your Food Library. Please check spelling.', '', `<button class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg" onclick="hideModal()">OK</button>`);
          return;
        }

        const mealToLog = [{
          mealType: 'Manual',
          foodItem: food['Food Item'],
          quantity,
          protein: (parseFloat(food['Protein (g)']) || 0) * quantity,
          carbs: (parseFloat(food['Carbs (g)']) || 0) * quantity,
          fats: (parseFloat(food['Fats (g)']) || 0) * quantity,
          calories: (parseFloat(food.Calories) || 0) * quantity,
        }];

        const payload = { action: 'logDiet', date: today, meals: mealToLog };
        await postData(payload);
        hideModal();
        fetchData();
      };
    }

    async function logProgress(event) {
      event.preventDefault();
      const form = event.target;
      const payload = { 
        action: 'logProgress', 
        date: form['progress-date'].value,
        weight: form['progress-weight'].value,
        waist: form['progress-waist'].value || '',
        chest: form['progress-chest'].value || '',
        arms: form['progress-arms'].value || '',
        thighs: form['progress-thighs'].value || '',
        photo: form['progress-photo'].value || ''
      };
      const success = await postData(payload);
      if(success) {
        form.reset();
        form['progress-date'].value = today;
        fetchData();
      }
    }
    
    async function updateGoals(event) {
        event.preventDefault();
        const inputs = document.getElementById('goals-list').querySelectorAll('input');
        const goalsToUpdate = {};
        inputs.forEach(input => {
            goalsToUpdate[input.dataset.goalName] = input.value;
        });
        const payload = { action: 'updateGoals', goals: goalsToUpdate };
        const success = await postData(payload);
        if (success) fetchData();
    }

    // ==================== ACTIVE WORKOUT ====================
    function startWorkoutSession() {
        const todayIndex = new Date().getDay();
        const workoutPlanToday = (appData.workoutPlan || []).find(p => dayNameToIndex(p.Day) === todayIndex);

        if (!workoutPlanToday) {
            showModal('No Workout', 'There is no workout planned for today.', '', `<button class="bg-gray-700 text-gray-200 font-bold py-2 px-4 rounded-lg" onclick="hideModal()">OK</button>`);
            return;
        }

        const exercises = Object.values(workoutPlanToday).filter(v => v && typeof v === 'string' && v.toLowerCase() !== dayOfWeek(todayIndex).toLowerCase());
        
        if (exercises.length === 0) {
            showModal('No Workout', 'No exercises found in today\'s plan.', '', `<button class="bg-gray-700 text-gray-200 font-bold py-2 px-4 rounded-lg" onclick="hideModal()">OK</button>`);
            return;
        }

        const sessionContainer = document.getElementById('active-workout-exercises');
        sessionContainer.innerHTML = ''; // Clear previous session

        exercises.forEach(exerciseName => {
            const exerciseId = exerciseName.replace(/\s+/g, '-');
            const card = document.createElement('div');
            card.className = 'bg-gray-800 rounded-lg p-4 shadow-md';
            card.innerHTML = `
                <form class="exercise-form space-y-3" data-exercise="${exerciseName}">
                    <h4 class="font-bold text-xl text-white">${exerciseName}</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label for="sets-${exerciseId}" class="block text-sm font-medium text-gray-400">Sets</label>
                            <input type="number" id="sets-${exerciseId}" class="sets-input w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" required />
                        </div>
                        <div>
                            <label for="reps-${exerciseId}" class="block text-sm font-medium text-gray-400">Reps</label>
                            <input type="number" id="reps-${exerciseId}" class="reps-input w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" required />
                        </div>
                        <div>
                            <label for="weight-${exerciseId}" class="block text-sm font-medium text-gray-400">Weight (kg)</label>
                            <input type="number" step="0.1" id="weight-${exerciseId}" class="weight-input w-full mt-1 bg-gray-700 text-gray-200 p-2 rounded-lg border border-gray-600" required />
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-lime-400 text-gray-900 font-bold py-2 rounded-lg transition hover:bg-lime-300">Log Exercise</button>
                </form>
            `;
            sessionContainer.appendChild(card);
        });

        document.getElementById('active-workout-session').classList.remove('hidden');
        document.getElementById('default-workout-view').classList.add('hidden');
        switchTab('workout');
    }

    function finishWorkoutSession() {
        document.getElementById('active-workout-session').classList.add('hidden');
        document.getElementById('default-workout-view').classList.remove('hidden');
        fetchData(); // Refresh the workout log
    }

    function dayOfWeek(dayIndex) {
        return ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][dayIndex];
    }
    
    // ==================== NAV ====================
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('text-lime-400'));
      document.getElementById(`nav-${tabId}`).classList.add('text-lime-400');
    }

    // ==================== EVENTS ====================
    document.getElementById('log-workout-btn').addEventListener('click', logWorkout);
    document.getElementById('start-workout-btn').addEventListener('click', startWorkoutSession);
    document.getElementById('finish-workout-btn').addEventListener('click', finishWorkoutSession);
    document.getElementById('active-workout-exercises').addEventListener('submit', async (event) => {
        event.preventDefault();
        const form = event.target.closest('.exercise-form');
        if (!form) return;

        const exerciseName = form.dataset.exercise;
        const button = form.querySelector('button[type="submit"]');

        const payload = {
            action: 'logWorkout',
            date: today,
            exercise: exerciseName,
            sets: form.querySelector('.sets-input').value,
            reps: form.querySelector('.reps-input').value,
            weight: form.querySelector('.weight-input').value,
            notes: ''
        };
        
        button.disabled = true;
        button.textContent = 'Logging...';

        const success = await postData(payload, false); // Post data without showing success modal

        if(success) {
            button.textContent = 'Logged ✔';
            button.classList.remove('bg-lime-400', 'hover:bg-lime-300');
            button.classList.add('bg-green-600', 'cursor-not-allowed');
        } else {
            button.disabled = false;
            button.textContent = 'Log Exercise';
            // Optionally show an error message specific to this exercise
        }
    });
    
    // --- NEW --- Event delegation for delete buttons
    document.getElementById('workout-log-list').addEventListener('click', (event) => {
        const deleteBtn = event.target.closest('.delete-workout-btn');
        if (deleteBtn) {
            const rowIndex = deleteBtn.dataset.rowIndex;
            confirmDeleteWorkout(rowIndex);
        }
    });

    document.getElementById('log-meal-btn').addEventListener('click', addFoodItem);
    document.getElementById('log-progress-form').addEventListener('submit', logProgress);
    document.getElementById('update-goals-form').addEventListener('submit', updateGoals);

    navItems.dashboard.addEventListener('click', () => switchTab('dashboard'));
    navItems.workout.addEventListener('click', () => switchTab('workout'));
    navItems.diet.addEventListener('click', () => switchTab('diet'));
    navItems.progress.addEventListener('click', () => switchTab('progress'));
    navItems.settings.addEventListener('click', () => switchTab('settings'));

    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('progress-date').value = today;
        fetchData();
    });
  </script>
</body>
</html>
